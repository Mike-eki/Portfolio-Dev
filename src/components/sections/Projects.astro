---
import GitHub from '../icons/GitHub.astro';
import ExternalLink from '../icons/ExternalLink.astro';
import Eye from '../icons/Eye.astro';
import Close from '../icons/Close.astro';

interface ProjectImage {
  src: string;
  alt: string;
}

interface CaseStudy {
  problem: string;
  requirements: string;
  decisions: string;
  technologies: string;
  approach: string;
  results: string;
}

interface ProjectCard {
  id: string;
  name: string;
  role: string;
  summary: string;
  technologies: string[];
  githubUrl: string;
  liveUrl?: string;
  image: ProjectImage;
  caseStudy: CaseStudy;
}

interface CaseStudyStructure {
  problem: string;
  requirements: string;
  decisions: string;
  technologies: string;
  approach: string;
  results: string;
}

interface Props {
  heading: string;
  intro: string;
  cards: ProjectCard[];
  caseStudyStructure: CaseStudyStructure;
}

const { heading, intro, cards, caseStudyStructure } = Astro.props as Props;
---

<section id="projects" class="px-6 py-12 space-y-10">
  <header class="space-y-2">
    <h2 class="text-2xl font-semibold">{heading}</h2>
    <p class="max-w-2xl text-sm text-slate-300">{intro}</p>
  </header>

  <div class="grid gap-4 sm:grid-cols-1 lg:grid-cols-2" aria-label={heading}>
    {cards.map((project) => (
      <article
        id={project.id}
        tabindex="0"
        data-project-card
        class="flex max-sm:flex-col h-full overflow-hidden rounded-lg border border-slate-800 bg-slate-900/40 shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 focus-visible:border-sky-400 transition-all"
      >
        <div class="relative w-1/2 max-sm:w-full flex-shrink-0 overflow-hidden border-r border-slate-800 bg-slate-900/80">
          <img
            src={project.image.src}
            alt={project.image.alt}
            loading="lazy"
            class="h-full w-full object-cover"
          />
        </div>
        <div class="flex flex-1 flex-col justify-between p-5">
          <div class="space-y-2">
            <h3 class="text-lg font-semibold">{project.name}</h3>
            <p class="text-xs uppercase tracking-wide text-sky-400">{project.role}</p>
            <p class="text-sm text-slate-300">{project.summary}</p>
            <div class="mt-2 flex flex-wrap gap-2 text-xs text-slate-400">
              {project.technologies.map((tech) => (
                <span class="inline-flex items-center rounded-md bg-gray-400/10 px-2 py-1 text-xs font-medium text-gray-400 inset-ring inset-ring-gray-400/20">{tech}</span>
              ))}
            </div>
          </div>
          <div class="mt-4 flex flex-wrap gap-2 text-sm">
            {project.githubUrl && (
              <a
                href={project.githubUrl}
                class="inline-flex items-center gap-1 rounded-md border border-slate-700 px-3 py-1 text-xs font-medium text-slate-100 hover:bg-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-300"
                target="_blank"
                rel="noreferrer noopener"
              >
                <GitHub />
                <span>GitHub</span>
              </a>
            )}
            {project.liveUrl && (
              <a
                href={project.liveUrl}
                class="inline-flex items-center gap-1 rounded-md border border-slate-700 px-3 py-1 text-xs font-medium text-slate-100 hover:bg-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-300"
                target="_blank"
                rel="noreferrer noopener"
              >
                <ExternalLink />
                <span>Live demo</span>
              </a>
            )}
            <button
              type="button"
              class="inline-flex items-center gap-1 rounded-md bg-sky-500 px-3 py-1 text-xs font-medium text-slate-950 hover:bg-sky-400 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-300"
              data-project-modal-open
              data-project-name={project.name}
              data-project-image-src={project.image.src}
              data-project-image-alt={project.image.alt}
              data-project-problem={project.caseStudy.problem}
              data-project-requirements={project.caseStudy.requirements}
              data-project-decisions={project.caseStudy.decisions}
              data-project-technologies={project.caseStudy.technologies}
              data-project-approach={project.caseStudy.approach}
              data-project-results={project.caseStudy.results}
            >
              <span>View details</span>
              <Eye />
            </button>
          </div>
        </div>
      </article>
    ))}
  </div>

  <div
    id="project-modal"
    class="fixed inset-0 z-[80] hidden flex items-center justify-center bg-black/60 p-4 overflow-y-auto m-0"
    style="margin: 0;"
    role="dialog"
    aria-modal="true"
    aria-labelledby="project-modal-title"
  >
    <div class="w-full max-w-xl rounded-lg border border-slate-700 bg-slate-950 p-6 text-sm text-slate-100 shadow-xl max-h-[90vh] overflow-y-auto">
      <header class="flex items-start justify-between gap-4">
        <div>
          <h2 id="project-modal-title" class="text-lg font-semibold"></h2>
          <p class="mt-1 text-xs text-slate-400">Detailed project case study</p>
        </div>
        <button
          type="button"
          class="rounded-full border border-slate-700 p-1 text-slate-300 hover:bg-slate-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-sky-300"
          data-project-modal-close
          aria-label="Close details"
        >
          <Close />
        </button>
      </header>
      <div class="mt-4 space-y-4 text-slate-200">
        <div class="mb-2 hidden overflow-hidden rounded-lg border border-slate-800 bg-slate-900/60" id="project-modal-image-wrapper">
          <img id="project-modal-image" src="" alt="" class="w-full object-cover" loading="lazy" />
        </div>
        <div>
          <h3 class="text-sm font-semibold tracking-wide text-sky-300 uppercase">{caseStudyStructure.problem}</h3>
          <p id="project-modal-problem" class="mt-1 text-slate-300"></p>
        </div>
        <div class="pt-3 border-t border-slate-800">
          <h3 class="text-sm font-semibold tracking-wide text-sky-300 uppercase">{caseStudyStructure.requirements}</h3>
          <p id="project-modal-requirements" class="mt-1 text-slate-300"></p>
        </div>
        <div class="pt-3 border-t border-slate-800">
          <h3 class="text-sm font-semibold tracking-wide text-sky-300 uppercase">{caseStudyStructure.decisions}</h3>
          <p id="project-modal-decisions" class="mt-1 text-slate-300"></p>
        </div>
        <div class="pt-3 border-t border-slate-800">
          <h3 class="text-sm font-semibold tracking-wide text-sky-300 uppercase">{caseStudyStructure.technologies}</h3>
          <p id="project-modal-technologies" class="mt-1 text-slate-300"></p>
        </div>
        <div class="pt-3 border-t border-slate-800">
          <h3 class="text-sm font-semibold tracking-wide text-sky-300 uppercase">{caseStudyStructure.approach}</h3>
          <p id="project-modal-approach" class="mt-1 text-slate-300"></p>
        </div>
        <div class="pt-3 border-t border-slate-800">
          <h3 class="text-sm font-semibold tracking-wide text-sky-300 uppercase">{caseStudyStructure.results}</h3>
          <p id="project-modal-results" class="mt-1 text-slate-300"></p>
        </div>
      </div>
    </div>
  </div>

  <script is:inline>
    const modal = document.getElementById('project-modal');
    const titleEl = document.getElementById('project-modal-title');
    const imageEl = document.getElementById('project-modal-image');
    const imageWrapper = document.getElementById('project-modal-image-wrapper');
    const fields = {
      problem: document.getElementById('project-modal-problem'),
      requirements: document.getElementById('project-modal-requirements'),
      decisions: document.getElementById('project-modal-decisions'),
      technologies: document.getElementById('project-modal-technologies'),
      approach: document.getElementById('project-modal-approach'),
      results: document.getElementById('project-modal-results'),
    };

    let lastTrigger = null;

    function openModal(button) {
      if (!modal || !titleEl) return;
      lastTrigger = button;
      titleEl.textContent = button.dataset.projectName || '';
      if (imageEl && imageWrapper) {
        const src = button.dataset.projectImageSrc || '';
        imageEl.src = src;
        imageEl.alt = button.dataset.projectImageAlt || '';
        imageWrapper.classList.toggle('hidden', !src);
      }
      fields.problem.textContent = button.dataset.projectProblem || '';
      fields.requirements.textContent = button.dataset.projectRequirements || '';
      fields.decisions.textContent = button.dataset.projectDecisions || '';
      fields.technologies.textContent = button.dataset.projectTechnologies || '';
      fields.approach.textContent = button.dataset.projectApproach || '';
      fields.results.textContent = button.dataset.projectResults || '';
      modal.classList.remove('hidden');
      modal.focus?.();
    }

    function closeModal() {
      if (!modal) return;
      modal.classList.add('hidden');
      if (lastTrigger && typeof lastTrigger.focus === 'function') {
        lastTrigger.focus();
      }
    }

    modal?.addEventListener('click', (event) => {
      if (event.target === modal) {
        closeModal();
      }
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && !modal?.classList.contains('hidden')) {
        closeModal();
      }
    });

    document.querySelectorAll('[data-project-modal-open]').forEach((btn) => {
      btn.addEventListener('click', () => openModal(btn));
    });

    document.querySelectorAll('[data-project-modal-close]').forEach((btn) => {
      btn.addEventListener('click', () => closeModal());
    });

    // Handle Enter key on project cards to focus and activate first button
    document.querySelectorAll('[data-project-card]').forEach((card) => {
      card.addEventListener('keydown', (event) => {
        // Only handle if the card itself is focused (not a child element)
        if (event.key === 'Enter' && event.target === card) {
          event.preventDefault();
          const firstButton = card.querySelector('button, a');
          if (firstButton) {
            // Focus first, then click to activate
            if (typeof firstButton.focus === 'function') {
              firstButton.focus();
            }
            if (typeof firstButton.click === 'function') {
              firstButton.click();
            }
          }
        }
      });
    });
  </script>
</section>
