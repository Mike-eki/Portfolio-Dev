---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getDict, DEFAULT_LANG } from '../i18n/i18n';
import Navigation from '../components/Navigation.astro';
import KeyboardGuide from '../components/KeyboardGuide.astro';
import HeroAbout from '../components/sections/HeroAbout.astro';
import Projects from '../components/sections/Projects.astro';
import Contact from '../components/sections/Contact.astro';

// Get all translations for client-side switching
const translations = {
  en: getDict('en'),
  es: getDict('es'),
};

const t = translations[DEFAULT_LANG];

// Encode email for obfuscation (reverse + base64)
const encodedEmail = btoa(t.contactInfo.emailValue.split('').reverse().join(''));
---

<BaseLayout lang={DEFAULT_LANG} title={t.common.siteTitle}>
  <KeyboardGuide title={t.keyboardGuide.title} shortcuts={t.keyboardGuide.shortcuts} />
  <Navigation items={t.nav.items} currentLang={DEFAULT_LANG} />
  
  <HeroAbout
    hero={t.hero} 
    about={t.about}
    contactInfo={t.contactInfo}
    encodedEmail={encodedEmail}
  />
  <Projects
    heading={t.projects.heading}
    intro={t.projects.intro}
    cards={t.projects.cards}
    caseStudyStructure={t.projects.caseStudyStructure}
  />
  <Contact
    heading={t.contactSection.heading}
    intro={t.contactSection.intro}
    email={t.contactInfo.emailValue}
    linkedinUrl={t.contactInfo.linkedinUrl}
    githubUrl={t.contactInfo.githubUrl}
    viewProfile={t.contactInfo.viewProfile}
    viewRepositories={t.contactInfo.viewRepositories}
    connectText={t.contactInfo.connectText}
  />
</BaseLayout>

<script is:inline define:vars={{ translations }}>
  // Embed translations
  window.__TRANSLATIONS__ = translations;
</script>

<script>
  import { LanguageSwitcher } from '../utils/languageSwitcher';
  import { initKeyboardNavigation } from '../keyboard/keyboardController';

  // Initialize language switcher
  const langSwitcher = new LanguageSwitcher('en', window.__TRANSLATIONS__);

  document.addEventListener('DOMContentLoaded', () => {
    // Load user's language preference
    langSwitcher.initFromPreference();
    
    // Initialize keyboard navigation
    const hasKeyboard = window.matchMedia('(pointer: fine)').matches;
    
    if (hasKeyboard) {
      const cleanup = initKeyboardNavigation({
        initialState: {
          section: 'hero',
          targetId: '',
          lang: langSwitcher.getLang(),
        },
        onLangChange: (newLang) => {
          langSwitcher.switchTo(newLang);
        },
      });

      window.addEventListener('beforeunload', cleanup);
    }
    
    // Language switcher button handler
    const langButton = document.getElementById('lang-switcher');
    if (langButton) {
      langButton.addEventListener('click', () => {
        langSwitcher.toggle();
      });
    }
  });
</script>
